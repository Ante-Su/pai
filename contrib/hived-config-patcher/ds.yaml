# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: hived-config-patcher-ds
spec:
  selector:
    matchLabels:
      app: hived-config-patcher
  template:
    metadata:
      name: hived-config-patcher
      labels:
        app: hived-config-patcher
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: pai-master
                    operator: In
                    values:
                      - "true"
      hostNetwork: false
      hostPID: false
      containers:
      - name: app
        image: openpai/hived-config-patcher
        imagePullPolicy: Always
        command: ["python"]
        args: [
          "./patcher.py",
          "--max-nodes={{cfg['openpai_worker_vmss']['max_vm_count']}}",
          "--node-name-prefix=k8s-opworker",
          "--hived-config-file=/hivedscheduler-config/hivedscheduler.yaml"
        ]
        volumeMounts:
        - name: hivedscheduler-config
          mountPath: /hivedscheduler-config
      volumes:
      - name: hivedscheduler-config
        configMap:
          name: hivedscheduler-config
      serviceAccountName: hived-config-patcher-account
